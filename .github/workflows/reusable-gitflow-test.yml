# =============================================================================
# REUSABLE GITFLOW TEST WORKFLOW
# =============================================================================
# This workflow provides standardized testing for feature branches and PRs
# across all QQQ repositories. It implements the DRY principle by centralizing
# all testing logic in one reusable workflow.
#
# USAGE:
#   - uses: Kingsrook/github-actions-library/.github/workflows/reusable-gitflow-test@main
#   - with:
#       project-type: 'hybrid'        # maven, npm, or hybrid
#       java-version: '17'           # Java version for Maven projects
#       node-version: '18'           # Node.js version for NPM projects
#       maven-args: ''               # Additional Maven arguments
#       npm-args: ''                 # Additional NPM arguments
#       maven-working-directory: '.' # Working directory for Maven project
#       npm-working-directory: '.'   # Working directory for NPM project
#
# WORKFLOW STEPS:
#   1. Environment Validation - Validates all required secrets and configurations
#   2. Build and Test - Builds and tests Maven and/or NPM projects
#   3. Artifact Collection - Uploads test results and coverage reports
#
# BRANCH TRIGGERS:
#   - develop, main, release/*, hotfix/*, feature/* branches
#   - Pull requests to develop and main
# =============================================================================

name: 'Reusable GitFlow Test Workflow'

on:
  workflow_call:
    inputs:
      project-type:
        description: 'Type of project (maven, npm, or hybrid)'
        required: true
        type: string
        default: 'hybrid'
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '18'
      maven-args:
        description: 'Additional Maven arguments'
        required: false
        type: string
        default: ''
      npm-args:
        description: 'Additional NPM arguments'
        required: false
        type: string
        default: ''
      maven-working-directory:
        description: 'Working directory for Maven project'
        required: false
        type: string
        default: '.'
      npm-working-directory:
        description: 'Working directory for NPM project'
        required: false
        type: string
        default: '.'

jobs:
  # ========================================================================
  # JOB 1: ENVIRONMENT VALIDATION
  # ========================================================================
  # This job runs first and validates all required environment variables,
  # secrets, and configurations. It's designed to fail fast if there are
  # any authentication or configuration issues.
  validate-environment:
    name: 'üîç Validate Environment'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Validate Environment & Secrets'
        uses: ./.github/actions/validate-environment
        with:
          project-type: ${{ inputs.project-type }}
          require-gpg: false
          require-maven: ${{ contains(inputs.project-type, 'maven') }}
          require-npm: ${{ contains(inputs.project-type, 'npm') }}

  # ========================================================================
  # JOB 2: BUILD AND TEST
  # ========================================================================
  # This job builds and tests the projects
  # - Runs Maven build lifecycle for Maven projects
  # - Runs NPM build and test for NPM projects
  # - Ensures quality before proceeding
  build-and-test:
    name: 'üî® Build and Test'
    runs-on: ubuntu-latest
    needs: validate-environment
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Build and Test Projects'
        uses: ./.github/actions/build-test
        with:
          project-type: ${{ inputs.project-type }}
          java-version: ${{ inputs.java-version }}
          node-version: ${{ inputs.node-version }}
          maven-args: ${{ inputs.maven-args }}
          npm-args: ${{ inputs.npm-args }}
          maven-working-directory: ${{ inputs.maven-working-directory }}
          npm-working-directory: ${{ inputs.npm-working-directory }}

  # ========================================================================
  # JOB 3: ARTIFACT COLLECTION
  # ========================================================================
  # This job collects test results and coverage reports
  # - Uploads Maven test results as artifacts
  # - Uploads NPM coverage reports as artifacts
  # - Continues even if no reports found (warn mode)
  artifact-collection:
    name: 'üì¶ Collect Artifacts'
    runs-on: ubuntu-latest
    needs: [validate-environment, build-and-test]
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Upload Maven Test Results'
        if: contains(inputs.project-type, 'maven')
        uses: actions/upload-artifact@v4
        with:
          name: maven-test-results
          path: ${{ inputs.maven-working-directory }}/target/surefire-reports/
          if-no-files-found: warn

      - name: 'Upload NPM Coverage Reports'
        if: contains(inputs.project-type, 'npm')
        uses: actions/upload-artifact@v4
        with:
          name: npm-coverage-reports
          path: ${{ inputs.npm-working-directory }}/coverage/
          if-no-files-found: warn
