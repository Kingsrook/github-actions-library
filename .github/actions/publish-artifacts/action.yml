name: 'Publish Artifacts'
description: 'Publishes artifacts to Maven Central and NPM registries'

inputs:
  project-type:
    description: 'Type of project (maven, npm, or hybrid)'
    required: true
    default: 'hybrid'
  maven-working-directory:
    description: 'Working directory for Maven project'
    required: false
    default: '.'
  npm-working-directory:
    description: 'Working directory for NPM project'
    required: false
    default: '.'
  maven-args:
    description: 'Additional Maven arguments'
    required: false
    default: ''
  npm-args:
    description: 'Additional NPM arguments'
    required: false
    default: ''
  publish-type:
    description: 'Type of publish (snapshot, rc, release)'
    required: true
    default: 'snapshot'

runs:
  using: 'composite'
  steps:
    - name: 'ğŸš€ Publish Artifacts Started'
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸš€ PUBLISH ARTIFACTS STARTED"
        echo "=========================================="
        echo "Project Type: ${{ inputs.project-type }}"
        echo "Publish Type: ${{ inputs.publish-type }}"
        echo "=========================================="

    - name: 'ğŸ” Setup GPG for Publishing'
      if: contains(inputs.project-type, 'maven') || contains(inputs.project-type, 'npm')
      uses: ./.github/actions/setup-gpg
      with:
        keyname: ${{ secrets.GPG_KEYNAME }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}

    - name: 'ğŸš€ Publish Maven Artifacts'
      if: contains(inputs.project-type, 'maven')
      shell: bash
      working-directory: ${{ inputs.maven-working-directory }}
      env:
        GPG_KEYNAME: ${{ secrets.GPG_KEYNAME }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
        CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
      run: |
        echo "ğŸš€ Publishing Maven artifacts..."
        
        case "${{ inputs.publish-type }}" in
          "snapshot")
            echo "ğŸ“¦ Publishing Maven snapshot..."
            mvn clean deploy -B \
              -DskipTests \
              -Dgpg.keyname="$GPG_KEYNAME" \
              -Dgpg.passphrase="$GPG_PASSPHRASE" \
              -Dcentral.username="$CENTRAL_USERNAME" \
              -Dcentral.password="$CENTRAL_PASSWORD" \
              ${{ inputs.maven-args }}
            ;;
          "rc"|"release")
            echo "ğŸ“¦ Publishing Maven release..."
            mvn clean deploy -B \
              -DskipTests \
              -Dgpg.keyname="$GPG_KEYNAME" \
              -Dgpg.passphrase="$GPG_PASSPHRASE" \
              -Dcentral.username="$CENTRAL_USERNAME" \
              -Dcentral.password="$CENTRAL_PASSWORD" \
              ${{ inputs.maven-args }}
            ;;
          *)
            echo "âŒ Unknown publish type: ${{ inputs.publish-type }}"
            exit 1
            ;;
        esac
        
        echo "âœ… Maven artifacts published"

    - name: 'ğŸš€ Publish NPM Artifacts'
      if: contains(inputs.project-type, 'npm')
      shell: bash
      working-directory: ${{ inputs.npm-working-directory }}
      env:
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: |
        echo "ğŸš€ Publishing NPM artifacts..."
        
        # Configure NPM for publishing
        echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
        
        case "${{ inputs.publish-type }}" in
          "snapshot")
            echo "ğŸ“¦ Publishing NPM snapshot..."
            npm publish --tag snapshot ${{ inputs.npm-args }}
            ;;
          "rc")
            echo "ğŸ“¦ Publishing NPM release candidate..."
            npm publish --tag rc ${{ inputs.npm-args }}
            ;;
          "release")
            echo "ğŸ“¦ Publishing NPM release..."
            npm publish --tag latest ${{ inputs.npm-args }}
            ;;
          *)
            echo "âŒ Unknown publish type: ${{ inputs.publish-type }}"
            exit 1
            ;;
        esac
        
        echo "âœ… NPM artifacts published"

    - name: 'ğŸš€ Publish Artifacts Complete'
      shell: bash
      run: |
        echo "=========================================="
        echo "ğŸš€ PUBLISH ARTIFACTS COMPLETE"
        echo "=========================================="
        echo "All artifacts published successfully"
        echo "=========================================="
